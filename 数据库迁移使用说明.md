# 数据库迁移使用说明

## 🎯 一句话总结

**本项目已支持完整的数据库迁移功能，可以轻松地在不同环境间迁移数据。**

## 🚀 三步快速开始

### 步骤 1: 导出数据库

在**源环境**（开发机或旧服务器）运行：

```bash
# Linux/Mac
./db_migration.sh export

# Windows
bash db_migration.sh export
```

导出成功后，会生成类似 `xinhua_db_20241209_143022.tar.gz` 的文件。

### 步骤 2: 传输文件

将导出的文件传输到目标服务器：

```bash
# 方式 1: 使用 SCP
scp xinhua_db_*.tar.gz user@target-server:/opt/xinhua-tool/

# 方式 2: 使用一键部署脚本（推荐）
./export_and_deploy.sh target-server
```

### 步骤 3: 导入并部署

在**目标环境**运行：

```bash
# Docker 部署并导入数据库
./deploy.sh docker --with-db xinhua_db_20241209_143022.tar.gz

# 或者单独导入数据库
./db_migration.sh import xinhua_db_20241209_143022.tar.gz
```

## ✨ 一键远程部署

**最简单的方式**：使用一键部署脚本

```bash
# 自动导出、传输、部署
./export_and_deploy.sh 192.168.1.100

# 指定用户和路径
./export_and_deploy.sh 192.168.1.100 ubuntu /opt/xinhua-tool
```

脚本会自动完成：
1. ✅ 导出本地数据库
2. ✅ 传输到远程服务器
3. ✅ 在远程服务器部署
4. ✅ 验证部署结果

## 📋 常用命令

### 数据库操作

```bash
# 导出数据库
./db_migration.sh export

# 导入数据库
./db_migration.sh import xinhua_db_*.tar.gz

# 验证数据库
./db_migration.sh verify

# 回滚到之前版本
./db_migration.sh rollback db_backup_before_import_*
```

### 部署操作

```bash
# Docker 部署
./deploy.sh docker

# Docker 部署 + 导入数据库
./deploy.sh docker --with-db xinhua_db_*.tar.gz

# Systemd 部署 + 导入数据库
sudo ./deploy.sh systemd --with-db xinhua_db_*.tar.gz
```

## ⚠️ 重要提示

1. **自动备份**: 导入数据库前会自动备份现有数据，无需担心数据丢失
2. **快速回滚**: 如果导入后有问题，可以快速回滚到之前的版本
3. **安全传输**: 所有数据传输都通过 SSH 加密
4. **权限问题**: 
   - Linux/Mac: 确保脚本有执行权限 `chmod +x *.sh`
   - Windows: 使用 Git Bash 或 WSL 运行脚本

## 💡 典型使用场景

### 场景 1: 开发环境 → 测试环境

```bash
# 在开发机
./db_migration.sh export

# 传输到测试服务器
scp xinhua_db_*.tar.gz test-server:/opt/xinhua-tool/

# 在测试服务器
./deploy.sh docker --with-db xinhua_db_*.tar.gz
```

### 场景 2: 服务器迁移

```bash
# 在旧服务器
./db_migration.sh export

# 在新服务器
./deploy.sh docker --with-db xinhua_db_*.tar.gz
```

### 场景 3: 定期备份

```bash
# 添加到 crontab（每天凌晨 2 点备份）
0 2 * * * cd /opt/xinhua-tool && ./db_migration.sh export
```

## 🔧 故障排查

### 问题 1: 脚本没有执行权限

```bash
# Linux/Mac
chmod +x db_migration.sh deploy.sh export_and_deploy.sh

# Windows
# 使用 Git Bash 或 WSL，无需 chmod
```

### 问题 2: 数据库文件不存在

```bash
# 创建空数据库文件
mkdir -p backend workflow-ctl/data
touch backend/app.db workflow-ctl/data/workflow.db
```

### 问题 3: SSH 连接失败

```bash
# 配置 SSH 密钥
ssh-keygen -t rsa -b 4096
ssh-copy-id user@remote-server

# 或者使用密码登录（按提示输入密码）
```

### 问题 4: 导入后数据不对

```bash
# 快速回滚
./db_migration.sh rollback db_backup_before_import_<timestamp>

# 重启服务
docker-compose restart
```

## 📚 详细文档

需要更多信息？查看完整文档：

- **[DATABASE_MIGRATION_GUIDE.md](DATABASE_MIGRATION_GUIDE.md)** - 完整的迁移指南
- **[DB_MIGRATION_QUICK_REFERENCE.md](DB_MIGRATION_QUICK_REFERENCE.md)** - 命令速查表
- **[DB_MIGRATION_EXAMPLES.md](DB_MIGRATION_EXAMPLES.md)** - 8 个实战示例
- **[DATABASE_MIGRATION_SUMMARY.md](DATABASE_MIGRATION_SUMMARY.md)** - 功能总结

## 🆘 需要帮助？

1. 查看脚本帮助信息：`./db_migration.sh help`
2. 查看部署日志：`docker-compose logs -f`
3. 验证数据库：`./db_migration.sh verify`
4. 查看备份：`ls -la db_backup_*`

## 🎓 最佳实践

1. **部署前测试**: 先在测试环境验证
2. **定期备份**: 每天自动备份数据库
3. **保留多版本**: 至少保留 7 天的备份
4. **验证数据**: 导入后验证数据完整性
5. **记录变更**: 记录每次迁移的时间和原因

---

**提示**: 如果你只是想快速部署，使用一键部署脚本最方便：

```bash
./export_and_deploy.sh <目标服务器IP>
```

**问题反馈**: 如有问题，请查看日志或联系技术支持。

